<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OASIS - Gerenciador de Hábitos</title>
    <link rel="stylesheet" href="styles.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Main Container -->
    <div class="container" id="mainContainer">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class='bx bx-water'></i>
                    <h1>OASIS</h1>
                </div>
                <button class="close-sidebar" id="closeSidebar" aria-label="Fechar menu">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-page="habits">
                    <i class='bx bx-list-check'></i>
                    <span>Hábitos</span>
                </a>
                <a href="#" class="nav-item" data-page="journal">
                    <i class='bx bx-book'></i>
                    <span>Diário</span>
                </a>
                <a href="#" class="nav-item" data-page="stats">
                    <i class='bx bx-bar-chart-alt-2'></i>
                    <span>Estatísticas</span>
                </a>
                <a href="#" class="nav-item" data-page="profile">
                    <i class='bx bx-user-circle'></i>
                    <span>Perfil</span>
                </a>
            </nav>
            <button class="logout-btn" id="logoutBtn">
                <i class='bx bx-log-out'></i>
                <span>Sair</span>
            </button>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <!-- Header -->
            <header class="header">
                <button class="menu-toggle" id="menuToggle">
                    <i class='bx bx-menu'></i>
                </button>
                <div class="header-info">
                    <h2 id="pageTitle">Meus Hábitos</h2>
                    <p id="pageSubtitle">Gerencie seus hábitos diários</p>
                </div>
                <div class="user-info">
                    <span id="userName">João Silva</span>
                    <div class="avatar">JS</div>
                </div>
            </header>

            <!-- Dynamic Content Container -->
            <div class="content-wrapper" id="contentWrapper">
                <!-- Habits Page (Default) -->
                <div class="page-content active" id="habitsPage">
                    <div class="page-header">
                        <div class="search-bar">
                            <i class='bx bx-search'></i>
                            <input type="text" id="searchHabits" placeholder="Buscar hábitos...">
                        </div>
                        <button class="btn btn-primary" id="addHabitBtn">
                            <i class='bx bx-plus'></i>
                            Novo Hábito
                        </button>
                    </div>
                    <div class="habits-grid" id="habitsGrid">
                        <!-- Habit cards will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Journal Page -->
                <div class="page-content" id="journalPage">
                    <div class="journal-container">
                        <div class="journal-header">
                            <h3>Registro Diário</h3>
                            <span class="journal-date" id="journalDate"></span>
                        </div>
                        <div class="journal-entry">
                            <textarea id="journalTextarea" placeholder="Como foi seu dia? Escreva suas reflexões..."></textarea>
                            <div class="journal-actions">
                                <button class="btn btn-secondary" id="clearJournalBtn">Limpar</button>
                                <button class="btn btn-primary" id="saveJournalBtn">
                                    <i class='bx bx-save'></i>
                                    Salvar
                                </button>
                            </div>
                        </div>
                        <div class="journal-history" id="journalHistory">
                            <!-- Previous entries will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- Statistics Page -->
                <div class="page-content" id="statsPage">
                    <div class="stats-container">
                        <div class="stats-summary">
                            <div class="stat-card">
                                <i class='bx bx-target-lock'></i>
                                <div class="stat-info">
                                    <h4>Taxa de Conclusão</h4>
                                    <p class="stat-value" id="completionRate">0%</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <i class='bx bx-trending-up'></i>
                                <div class="stat-info">
                                    <h4>Maior Sequência</h4>
                                    <p class="stat-value" id="longestStreak">0 dias</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <i class='bx bx-list-ul'></i>
                                <div class="stat-info">
                                    <h4>Total de Hábitos</h4>
                                    <p class="stat-value" id="totalHabits">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>Progresso Semanal</h3>
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Profile Page -->
                <div class="page-content" id="profilePage">
                    <div class="profile-container">
                        <div class="profile-header">
                            <div class="profile-avatar-container">
                                <div class="profile-avatar-large" id="profileAvatarLarge">AS</div>
                                <label for="profilePhotoInput" class="upload-photo-btn" title="Alterar foto">
                                    <i class='bx bx-camera'></i>
                                </label>
                                <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;">
                            </div>
                            <h3 id="profileName">Nome do Usuário</h3>
                            <p id="profileEmail">email@exemplo.com</p>
                        </div>
                        <div class="profile-form">
                            <form id="profileForm">
                                <div class="form-group">
                                    <label for="profileNameInput">Nome *</label>
                                    <input type="text" id="profileNameInput" required placeholder="Seu nome completo">
                                </div>
                                <div class="form-group">
                                    <label for="profileEmailInput">Email *</label>
                                    <input type="email" id="profileEmailInput" required placeholder="seu@email.com">
                                </div>
                                <div class="form-group">
                                    <label for="profileBirthDate">Data de Nascimento</label>
                                    <input type="date" id="profileBirthDate">
                                </div>
                                <div class="form-group">
                                    <label for="profileAge">Idade</label>
                                    <input type="number" id="profileAge" min="1" max="120">
                                </div>
                                <div class="form-group">
                                    <label for="profileGender">Sexo</label>
                                    <select id="profileGender">
                                        <option value="">Selecione</option>
                                        <option value="M">Masculino</option>
                                        <option value="F">Feminino</option>
                                        <option value="O">Outro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="profilePassword">Nova Senha (deixe em branco para não alterar)</label>
                                    <input type="password" id="profilePassword" placeholder="••••••••">
                                    <small>Mínimo de 6 caracteres</small>
                                </div>
                                <div style="display: flex; justify-content: flex-end; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
                                    <button type="button" class="btn btn-secondary" id="cancelProfileBtn">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class='bx bx-save'></i>
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal for Add/Edit Habit -->
    <div class="modal" id="habitModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Novo Hábito</h3>
                <button class="modal-close" id="closeModal" aria-label="Fechar modal">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <form id="habitForm">
                <div class="form-group">
                    <label for="habitTitle">Título do Hábito *</label>
                    <input type="text" id="habitTitle" required placeholder="Ex: Meditar 10 minutos">
                </div>
                <div class="form-group">
                    <label for="habitDescription">Descrição</label>
                    <textarea id="habitDescription" rows="3" placeholder="Descreva seu hábito..."></textarea>
                </div>
                <div class="form-group">
                    <label for="habitCategory">Categoria *</label>
                    <select id="habitCategory" required>
                        <option value="">Selecione uma categoria</option>
                        <!-- Categorias serão carregadas dinamicamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="habitRepeat">Repetir?</label>
                    <select id="habitRepeat">
                        <option value="false">Não</option>
                        <option value="true">Sim</option>
                    </select>
                </div>
                <div class="form-group" id="repeatTypeGroup" style="display: none;">
                    <label for="habitRepeatType">Tipo de Repetição *</label>
                    <select id="habitRepeatType">
                        <option value="diario">Diariamente</option>
                        <option value="semanal">Semanalmente</option>
                        <option value="mensal">Mensalmente</option>
                    </select>
                    <small>O hábito será repetido sempre no mesmo dia (ex: todo dia 17 se escolher mensal)</small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelModal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class='bx bx-check'></i>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div class="modal" id="deleteModal" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3 id="deleteModalTitle">Confirmar Exclusão</h3>
                <button class="modal-close" id="closeDeleteModal" aria-label="Fechar modal">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este hábito? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelDelete">Cancelar</button>
                <button class="btn btn-danger" id="confirmDelete">
                    <i class='bx bx-trash'></i>
                    Excluir
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Logout Confirmation -->
    <div class="modal" id="logoutModal" role="dialog" aria-modal="true" aria-labelledby="logoutModalTitle">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3 id="logoutModalTitle">Confirmar Saída</h3>
                <button class="modal-close" id="closeLogoutModal" aria-label="Fechar modal">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Deseja realmente sair do sistema?</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelLogout">Cancelar</button>
                <button class="btn btn-danger" id="confirmLogout">
                    <i class='bx bx-log-out'></i>
                    Sair
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Delete Journal Entry -->
    <div class="modal" id="deleteJournalModal" role="dialog" aria-modal="true" aria-labelledby="deleteJournalModalTitle">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3 id="deleteJournalModalTitle">Confirmar Exclusão</h3>
                <button class="modal-close" id="closeDeleteJournalModal" aria-label="Fechar modal">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir esta entrada do diário? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelDeleteJournal">Cancelar</button>
                <button class="btn btn-danger" id="confirmDeleteJournal">
                    <i class='bx bx-trash'></i>
                    Excluir
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Edit Journal Entry -->
    <div class="modal" id="editJournalModal" role="dialog" aria-modal="true" aria-labelledby="editJournalModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="editJournalModalTitle">Editar Entrada</h3>
                <button class="modal-close" id="closeEditJournalModal" aria-label="Fechar modal">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <form id="editJournalForm">
                <div class="form-group">
                    <label for="editJournalContent">Conteúdo *</label>
                    <textarea id="editJournalContent" rows="8" required placeholder="Escreva suas reflexões..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEditJournal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class='bx bx-save'></i>
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Validação de dados do localStorage antes de carregar app
        (function() {
            const user = localStorage.getItem('oasis_user');
            const token = localStorage.getItem('oasis_token');
            
            if (!token || !user) {
                console.warn('⚠️ Token ou usuário não encontrado. Redirecionando para login...');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const parsed = JSON.parse(user);
                if (!parsed.id || parsed.id === null || parsed.id === undefined) {
                    console.warn('⚠️ Usuário inválido (sem ID). Redirecionando para login...');
                    localStorage.removeItem('oasis_user');
                    localStorage.removeItem('oasis_token');
                    window.location.href = 'login.html';
                    return;
                }
                console.log('✅ Dados válidos. User ID:', parsed.id);
            } catch (e) {
                console.error('❌ Erro ao validar usuário:', e);
                localStorage.removeItem('oasis_user');
                localStorage.removeItem('oasis_token');
                window.location.href = 'login.html';
            }
        })();
    </script>
    <script src="api.js"></script>
    <script src="auth.js"></script>
    <script src="app.js"></script>
</body>
</html>